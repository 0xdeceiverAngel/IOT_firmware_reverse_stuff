
Ref:
- https://github.com/nahueldsanchez/blogpost_qiling_dlink_1/blob/master/readme.md
- https://www.exploit-db.com/exploits/27283
- https://github.com/rapid7/metasploit-framework/blob/master//modules/exploits/linux/http/dlink_hedwig_cgi_bof.rb

Download from
- https://ftp.dlink.ru/pub/Router/DIR-645/Firmware/DIR645A1_FW103RUB08.bin



# FAIL to extract firmware

Reason , `sasquatch` error

```bash
user@vm-ubuntu20:~/cve201307389/_DIR-645_REVA1_FW105B01.bin.extracted$ binwalk 160090.squashfs -e

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------

WARNING: Extractor.execute failed to run external extractor 'sasquatch -p 1 -le -d 'squashfs-root' '%e'': [Errno 2] No such file or directory: 'sasquatch', 'sasquatch -p 1 -le -d 'squashfs-root' '%e'' might not be installed correctly

WARNING: Extractor.execute failed to run external extractor 'sasquatch -p 1 -be -d 'squashfs-root' '%e'': [Errno 2] No such file or directory: 'sasquatch', 'sasquatch -p 1 -be -d 'squashfs-root' '%e'' might not be installed correctly
0             0x0             Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 6165003 bytes, 2205 inodes, blocksize: 262144 bytes, created: 2015-04-19 09:08:44
```

Clone `sasquatch` and run `build` ,it will show

```
user@vm-ubuntu20:~/cve201307389/sasquatch$ ./build.sh 
Reading package lists... Done
...
cc -g -O2  -I. -I./LZMA/lzma465/C -I./LZMA/lzmalt -I./LZMA/lzmadaptive/C/7zip/Compress/LZMA_Lib -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_GNU_SOURCE -DCOMP_DEFAULT=\"gzip\" -Wall -Werror  -DGZIP_SUPPORT -DLZMA_SUPPORT -DXZ_SUPPORT -DLZO_SUPPORT -DXATTR_SUPPORT -DXATTR_DEFAULT   -c -o unsquashfs.o unsquashfs.c
unsquashfs.c: In function ‘read_super’:
unsquashfs.c:1835:5: error: this ‘if’ clause does not guard... [-Werror=misleading-indentation]
 1835 |     if(swap)
      |     ^~
unsquashfs.c:1841:9: note: ...this statement, but the latter is misleadingly indented as if it were guarded by the ‘if’
 1841 |         read_fs_bytes(fd, SQUASHFS_START, sizeof(struct squashfs_super_block),
      |         ^~~~~~~~~~~~~
cc1: all warnings being treated as errors
```

Add curly brackets

```
user@vm-ubuntu20:~/cve201307389/sasquatch/squashfs4.3/squashfs-tools$ cat -n unsquashfs.c |grep 1835 -A 4
  1835      if(swap)
  1836          {
  1837          ERROR("Reading a different endian SQUASHFS filesystem on %s\n", source);
  1838          }
  1839
```

Compile again

```
user@vm-ubuntu20:~/cve201307389/sasquatch/squashfs4.3/squashfs-tools$ sudo make install 


...

/usr/bin/ld: unsquash-1.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: multiple definition of `verbose'; unsquashfs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: first defined here
/usr/bin/ld: unsquash-2.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: multiple definition of `verbose'; unsquashfs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: first defined here
/usr/bin/ld: unsquash-3.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: multiple definition of `verbose'; unsquashfs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: first defined here
/usr/bin/ld: unsquash-4.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: multiple definition of `verbose'; unsquashfs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: first defined here
/usr/bin/ld: compressor.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: multiple definition of `verbose'; unsquashfs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: first defined here
/usr/bin/ld: unsquashfs_info.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: multiple definition of `verbose'; unsquashfs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: first defined here
/usr/bin/ld: lzma_wrapper.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: multiple definition of `verbose'; unsquashfs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: first defined here
/usr/bin/ld: read_xattrs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: multiple definition of `verbose'; unsquashfs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: first defined here
/usr/bin/ld: unsquashfs_xattr.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: multiple definition of `verbose'; unsquashfs.o:/home/user/cve201307389/sasquatch/squashfs4.3/squashfs-tools/error.h:34: first defined here
collect2: error: ld returned 1 exit status
```

```bash
user@vm-ubuntu20:~$ binwalk 

Binwalk v2.3.3
Craig Heffner, ReFirmLabs
```
# Work on other version 

It looks like self compile version of binwalk when I install FirmAE

```bash
user@vm-ubuntu18:~/firmware/_DIR645A1_FW103RUB08.bin.extracted$ binwalk 

Binwalk v2.3.3+55cabd8
```

```
user@vm-ubuntu20:~/DIR645A1/DIR645A1_FW103RUB08_squashfs-root/htdocs$ ln -s  cgibin hedwig.cgi
```

# Reverse hedwig.cgi


```c
int hedwigcgi_main()
{
  char *v0; // $v0
  const char *v1; // $a1
  FILE *v2; // $s0
  int v3; // $fp
  int v4; // $s5
  int v5; // $v0
  const char *string; // $v0
  FILE *v7; // $s2
  int v8; // $v0
  int v9; // $s7
  int v10; // $v0
  int *v11; // $s1
  int i; // $s3
  char *v13; // $v0
  const char **v14; // $s1
  int v15; // $s0
  char *v16; // $v0
  const char **v17; // $s1
  int v18; // $s0
  int v19; // $v0
  const char *v20; // $v0
  char v22[20]; // [sp+18h] [-4A8h] BYREF
  char *v23; // [sp+2Ch] [-494h] BYREF
  char *v24; // [sp+30h] [-490h]
  int v25[3]; // [sp+34h] [-48Ch] BYREF
  char v26[128]; // [sp+40h] [-480h] BYREF
  char v27[1024]; // [sp+C0h] [-400h] BYREF

  memset(v27, 0, sizeof(v27));
  memset(v26, 0, sizeof(v26));
  strcpy(v22, "/runtime/session");
  v0 = getenv("REQUEST_METHOD");
  if ( !v0 )
  {
    v1 = "no REQUEST";
LABEL_7:
    v3 = 0;
    v4 = 0;
LABEL_34:
    v9 = -1;
    goto LABEL_25;
  }
  if ( strcasecmp(v0, "POST") )
  {
    v1 = "unsupported HTTP request";
    goto LABEL_7;
  }
  cgibin_parse_request(sub_40C5AC, 0, 0x20000);
  v2 = fopen("/etc/config/image_sign", "r");
  if ( !fgets(v26, 128, v2) )
  {
    v1 = "unable to read signature!";
    goto LABEL_7;
  }
  fclose(v2);
  cgibin_reatwhite(v26);
  v4 = sobj_new();
  v5 = sobj_new();
  v3 = v5;
  if ( !v4 || !v5 )
  {
    v1 = "unable to allocate string object";
    goto LABEL_34;
  }
  sess_get_uid(v4);
  string = (const char *)sobj_get_string(v4);
  sprintf(v27, "%s/%s/postxml", "/runtime/session", string);
  xmldbc_del(0, 0, v27);
```

String table in ida and ghidra not found `uid` , but exist in binary
# Emulation 

Call stack
- hedwigcgi_main
	- sess_get_uid
		- sobj_add_string 
			- strcpy to malloc space
	- sprintf copy to stack var -> casue overflow

But somehow strcpy doesn't work , the variable still empty
```bash
user@vm-ubuntu20:~/DIR645A1$ python3 emulate_cgibin.py 
[=]     mmap(addr = 0x0, length = 0x1000, prot = 0x3, flags = 0x802, fd = 0xffffffff, pgoffset = 0x0) = 0x90000000
[=]     open(filename = 0x7ff3baa0, flags = 0x0, mode = 0x0) = 0x3
[=]     fstat(fd = 0x3, buf_ptr = 0x7ff3b920) = 0x0
[=]     mmap(addr = 0x0, length = 0x1000, prot = 0x3, flags = 0x802, fd = 0xffffffff, pgoffset = 0x0) = 0x90001000
[=]     read(fd = 0x3, buf = 0x90001000, length = 0x1000) = 0x1000
[=]     mmap(addr = 0x0, length = 0x3a000, prot = 0x0, flags = 0x802, fd = 0xffffffff, pgoffset = 0x0) = 0x90002000
[=]     mmap(addr = 0x90002000, length = 0x2860c, prot = 0x5, flags = 0x12, fd = 0x3, pgoffset = 0x0) = 0x90002000
[=]     mmap(addr = 0x9003b000, length = 0x960, prot = 0x3, flags = 0x12, fd = 0x3, pgoffset = 0x29000) = 0x9003b000
[=]     close(fd = 0x3) = 0x0
[=]     munmap(addr = 0x90001000, length = 0x1000) = 0x0
[=]     open(filename = 0x7ff3ba90, flags = 0x0, mode = 0x0) = 0x3
[=]     fstat(fd = 0x3, buf_ptr = 0x7ff3b910) = 0x0
[=]     mmap(addr = 0x0, length = 0x1000, prot = 0x3, flags = 0x802, fd = 0xffffffff, pgoffset = 0x0) = 0x90001000
[=]     read(fd = 0x3, buf = 0x90001000, length = 0x1000) = 0x1000
[=]     mmap(addr = 0x0, length = 0x74000, prot = 0x0, flags = 0x802, fd = 0xffffffff, pgoffset = 0x0) = 0x9003c000
[=]     mmap(addr = 0x9003c000, length = 0x5d3e0, prot = 0x5, flags = 0x12, fd = 0x3, pgoffset = 0x0) = 0x9003c000
[=]     mmap(addr = 0x900a9000, length = 0x1e54, prot = 0x3, flags = 0x12, fd = 0x3, pgoffset = 0x5d000) = 0x900a9000
[=]     mmap(addr = 0x900ab000, length = 0x4910, prot = 0x3, flags = 0x812, fd = 0xffffffff, pgoffset = 0x0) = 0x900ab000
[=]     close(fd = 0x3) = 0x0
[=]     munmap(addr = 0x90001000, length = 0x1000) = 0x0
[=]     open(filename = 0x7ff3ba80, flags = 0x0, mode = 0x0) = 0x3
[=]     fstat(fd = 0x3, buf_ptr = 0x7ff3b900) = 0x0
[=]     close(fd = 0x3) = 0x0
[=]     stat(path = 0x900004b0, buf_ptr = 0x7ff3c344) = 0x0
[=]     mprotect(start = 0x900a9000, mlen = 0x1000, prot = 0x1) = 0x0
[=]     mprotect(start = 0x47ce000, mlen = 0x1000, prot = 0x1) = 0x0
[=]     ioctl(fd = 0x0, cmd = 0x540d, arg = 0x7ff3c228) = -0x1 (EPERM)
[=]     ioctl(fd = 0x1, cmd = 0x540d, arg = 0x7ff3c228) = -0x1 (EPERM)
[+]: At [main] **
[+]: At [hedwingcgi_main] **
[x]: hook malloc start
[x]: size 0x18
[=]     brk(inp = 0x0) = 0x437000
[=]     brk(inp = 0x438000) = 0x438000
[x]: hook malloc end
[x]: v0 0x437008
[x]: hook malloc start
[x]: size 0x18
[x]: hook malloc end
[x]: v0 0x437028
[=]     open(filename = 0x41fbec, flags = 0x0, mode = 0x0) = 0x3
[=]     ioctl(fd = 0x3, cmd = 0x540d, arg = 0x7ff3c038) = -0x1 (EPERM)
[=]     brk(inp = 0x439000) = 0x439000
[=]     read(fd = 0x3, buf = 0x437098, length = 0x1000) = 0x1b
[=]     close(fd = 0x3) = 0x0
[x]: hook malloc start
[x]: size 0x18
[x]: hook malloc end
[x]: v0 0x437008
[x]: hook malloc start
[x]: size 0x18
[x]: hook malloc end
[x]: v0 0x437028
[+]: At [sess_get_uid] ** 0x4083f0
[x]: hook malloc start
[x]: size 0x18
[x]: hook malloc end
[x]: v0 0x437048
[x]: hook malloc start
[x]: size 0x18
[x]: hook malloc end
[x]: v0 0x437068
[x]: hook malloc start
[x]: size 0x21
[x]: hook malloc end
[x]: v0 0x437088
[x]: hook malloc start
[x]: size 0x21
[x]: hook malloc end
[x]: v0 0x4370b0
[x]: hook malloc start
[x]: size 0x21
[x]: hook malloc end
[x]: v0 0x437898
[+]: hook strcpy   // here
[+]: 0x437898      // dest addr
[+]: 2000          // src  len
[x]: strcpy_end end
[x]: v0 0x0        // strcpy return 0 ,fail to copy
[+]: Ret from sobj_add_string **
[x]: read_a3
[x]: a3 0x437898
[x]: a3 bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')
[=]     socket(domain = 0x1, socktype = 0x2, protocol = 0x0) = 0x3
[=]     fcntl(fd = 0x3, cmd = 0x2, arg = 0x1) = 0x0
[=]     connect(sockfd = 0x3, addr = 0x7ff3c020, addrlen = 0x6e) = -0x1 (EPERM)
[=]     close(fd = 0x3) = 0x0
[=]     open(filename = 0x42083c, flags = 0x301, mode = 0x1b6) = -0x1 (EPERM)
HTTP/1.1 200 OK
Content-Type: text/xml

<hedwig><result>FAILED</result><message>unable to open temp file.</message></hedwig>[=]         write(fd = 0x1, buf = 0x900ad038, count = 0x7f) = 0x7f
[=]     exit(code = 0xffffffff) = ?
```


